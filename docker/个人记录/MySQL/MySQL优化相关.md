# schema与数据类型的优化

## 尽量选择合适的数据类型。

举例1：性别之类的，你可以用tinyint，因为只有0和1，注意int(1)和tinyint实际占用的空间还是有区别的。

举例2：ip地址，不一定要用字符串，因为mysql有个函数，INET_AT0N和INET_NTOA可以进行转换，使用int类型将占据更小的空间。

```mysql
MariaDB [(none)]> select INET_ATON('192.168.0.11');                                                                                               
+---------------------------+
| INET_ATON('192.168.0.11') |
+---------------------------+
|                3232235531 |
+---------------------------+
1 row in set (0.000 sec)

MariaDB [(none)]> select INET_NTOA('3232235531');
+-------------------------+
| INET_NTOA('3232235531') |
+-------------------------+
| 192.168.0.11            |
+-------------------------+
1 row in set (0.000 sec)

```

当然，使用函数，会带来额外的性能开销，你不一定要这样做，但你必须知道有这回事，如果公司的业务，偏重于节省空间，那么应该考虑使用int类型，如果偏重于性能，则考虑使用字符串。



## 尽量避免使用null

尽量避免，不代表不使用。有些特定场景下，比如用户信息之类的，不可能让用户全部填写，你可能需要使用null。

如果你要用特殊字符代替，那这个时候需要慎重。因为特殊字符有可能是你的可选信息中的一种。当然使用空字符串代替null还是可以考虑的

## 具体实现细则

### 整型

1. tinyint —8位
2. smallint —16位
3. mediumint — 24位
4. int —  32位
5. bigint — 64位

注意，这个就是二进制的位，不是长度。这里8位就是1个字节。

所以，你设计了int(1)，并不是说，你只能存长度为1的数字。

例如，你的id字段，是tinyint的话，那么他的范围就是0-127，因为8位的话，最高位是符号位。所以实际只能用7位。

所以，实际情况下，你都不需要为整型设计长度。

### 字符串

1. char

2. varchar

   2.1 使用最小的符合需求的长度

   2.2 varchar(n)，n小于等于255使用额外一个字节保存长度，n>255使用额外两个字节保存长度

   2.3 varchar(5)与varchar(255)保存同样的内容，硬盘存储空间相同，但内存空间占用不同。

   2.4 varchar在mysql5.6之前变更长度，或者从255一下变更到255以上时，都会导致锁表。

3. text（几乎不用）

4. blob（几乎不用）

像text和blob几乎不用的，我们完全可以存到文件里，然后把文件地址存到数据库里。

字符串类型的长度，就是实际长度。比如varchar(12)，那你的字符串长度就不能超过12

### 时间类型

1. datetime

   1.1 占用8个字节

   1.2 与时区无关，数据库底层时区配置，对datetime无效

   1.3 可保存到毫秒

   1.4 可保存时间范围大

   1.5 不要使用字符串存储日期类型，占用空间大，损失日期函数的便捷性

2. timestamp

   2.1 占用4个字节

   2.2 时间范围：1970-01-01到2038-01-19

   2.3 精确到秒

   2.4 采用整型存储

   2.5 依赖数据库设置的时区

   2.6 自动更新timestamp列的值

3. date

   3.1 只使用3个字节

   3.2 date类型用于保存1000-01-01到9999-12-31之间的日期

实际项目里，timestamp用的比较多

## 范式和反范式

所谓范式，其实就是为了避免数据冗余性。而反范式，就是让数据冗余。

使用范式的优点：

1. 减少数据储存。
2. 修改和删除时，单一操作，绝对一致性。

使用范式的缺点：

1. 多表关联join查询，性能大大降低。



使用反范式的优点和缺点，则刚好相反。

使用反范式的优点：

1. 查询性能大大提升

使用反范式的缺点：

1. 数据进行更新和删除时，容易造成一致性的问题。（你必须确保冗余数据也被更新）
2. 数据存储增加

通常来说，范式和反范式都是要结合使用的。一般的设计，肯定是优先遵从范式的。但具体实际上，对有些数据进行冗余是有必要的。

什么情况下进行数据冗余：

1. 被频繁引用且只能通过join 2张（或者更多）大表的方式，才能得到的独立小字段

**问题：是否可以使用视图代替？**
答：视图本质上只不过是提前写好了SQL。你在查询视图的过程中，其实还是要执行一遍视图那个SQL，所以和查基表是没区别的。但是Oracle有物化视图，是把视图数据真正落盘的。如果你变更基表，oracle提供了两种方式，一种是你更新的时候变更，一种是你更新后，再次查询的时候变更，这样实际上是帮你做掉了维护冗余数据的事情。但MySQL没有提供这种功能，如果你要这样做，得自己去维护数据的一致性。

## 主键的选择

代理主键：与业务无关

自然主键：与业务自身有关的

## 字符集的选择

1. 如果确定只有纯拉丁字符的储存，那么选择latin1就够了，不需要再选择其他的。这能够节省大量的存储空间
2. 如果我们确定可以不需要存储多种语言，就没必要非得使用UTF8或其他UNICODE字符类型。这会造成大量的存储空间浪费。

